---
title: "Functional heterogeneity in Mesenchymal stromal cell (MSC) subtypes."
author: "Emma Rand"
output:
  html_document:
    df_print: paged
  bookdown::html_document2: default
  bookdown::pdf_document2: default
  bookdown::word_document2: default
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE,
                      fig.retina = 3)
```

```{r pkg}
library(tidyverse)
library(heatmaply)
library(GGally)
```

```{r functions}
# data_summary calculates summary statistics (mean, sample size, standard deviation, standard error) for a numeric variable. Used to summarise the protein abundances for each cell line
source("functions/data_summary.R")
# z_score performs z score normalisation on a vector of values
source("functions/z_score.R")
```

# Introduction

Mesenchymal stromal cells (MSCs) are a subset non-hematopoietic adult stem cells that originate from the mesoderm. They have the capacity for self-renewal and differentiation into osteoblasts, adipocytes and chondrocytes making them important for the development of cell-based therapies in regenerative medicine. However, populations of MSCs are heterogeneous with respect to their differentiation capacity [@Costa2020-ze; @Phinney2012-yw] and some exhibit immundomodulatory properties unhelpful for cell-based therapies. Understanding subtype heterogeneity is key for the development of efficacious therapies. The Genever Group has developed a model of this heterogeneity using has a number of immortalised clonal MSC lines which comprises five subtypes [@Stone2019-wr; @Kay2019-ec]. The phenotypes of these subtypes is as follows:

-   Y201 : the MSC stereotype which differentiate into osteoblasts, adipocytes and chondrocytes
-   Y101 : osteogenic capacity
-   Y202 : immundomodulatory capacity
-   Y102 : immundomodulatory capacity
-   Y101.5 : enhanced osteogenic capacity

The data are mass spectrometry data of the soluble protein fraction from five immortalised mesenchymal stromal cell (MSC) lines.

# Raw data description

There are two data file. [Y101_Y102_Y201_Y202_Y101-5.csv](%22data-raw/Y101_Y102_Y201_Y202_Y101-5.csv%22) and [comparison_p\_and_q.csv](%22data-raw/comparison_p_and_q.csv%22)

The data in Y101_Y102_Y201_Y202_Y101-5.csv are normalised protein abundances. Each row is a protein and there are three replicates for each subtype which are arranged in columns. Also in the file are columns for:

-   the protein accessions: the top hit is first, Human sequences are prefixed with `1::`, bovine with `2::`
-   the number of peptides used to identify the protein
-   the number of unique peptides used to identify the protein
-   a measure of confidence in that identification
-   the maximum fold change between the mean abundances of two cell lines (i.e., highest mean / lowest mean)
-   a p value for a comparison test between the highest mean and lowest mean
-   a q value (corrected p value)
-   a measure of the power of that test
-   the cell line with the highest mean
-   the cell line with the lowest mean
-   the protein mass
-   a description of the protein
-   a binary indicator variable for whether at least two peptides were detected for a protein.

The data in comparison_p\_and_q.csv give the p and q values for pairwise comparisons between cell line.

```{r data-import}
# file
filesol <- "data-raw/Y101_Y102_Y201_Y202_Y101-5.csv"
# Column names are spread over three rows but are primarily in the third row.
# skip first two lines
sol <- read_csv(filesol, skip = 2) %>% 
  janitor::clean_names()

file <- "data-raw/comparison_p_and_q.csv"
p_q <- read_csv(file) %>% 
  janitor::clean_names()


```


# Methods

## Data preparation
```{r data-filter}
# Remove irrelevant rows

# bovine serum proteins removed - these are from medium on which the cells were grown 
# proteins for which fewer than 2 peptides were detected
sol <- sol %>% 
  filter(str_detect(description, "OS=Homo sapiens")) %>% 
  filter(x1pep == "x")
num_prot <- length(sol$accession) 

p_q <- p_q %>% 
  filter(str_detect(description, "OS=Homo sapiens")) %>% 
  filter(x1pep == "x")

```

```{r add-useful-columns}
# Extract important information 'hidden' in other columns to columns of their own

# extract the genename from the description and put it in a column.
# genename is after GN= in the description until a white space
sol <- sol %>%
  mutate(genename =  str_extract(description,"GN=[^\\s]+") %>% 
           str_replace("GN=", ""))

p_q <- p_q %>%
  mutate(genename =  str_extract(description,"GN=[^\\s]+") %>% 
           str_replace("GN=", ""))


# Add a column, protid, for the top protein identifier. 
# This is the first Uniprot ID after the "1::" in the accession column.
sol <- sol %>%
  mutate(protid =  str_extract(accession, "1::[^;]+") %>% 
           str_replace("1::", ""))

```

```{r create-long-sol2}
# Create a second dataframe, sol2 in which the protein abundances are in a single column
# these are the columns beginning with a y
# the column names which indicate the cell lineage and replicate
# good to a column named lineage_rep which is then split into separate columns
# All the other variables are retained.
sol2 <- sol %>% pivot_longer(names_to = "lineage_rep",
                             values_to = "abundance",
                             cols = starts_with("y")) %>%
  extract(lineage_rep,
          c("line", "rep"),
          "(y[0-9]{3,4})\\_([a-c])")
```

```{r summary-sol}
# Add columns for means for each cell line and genes
# add a dataframe for the mean, se, sd, and n abundance for each cell line
sol_summary <- data_summary(sol2, 
                            measure = abundance, 
                            group1 = line,
                            group2 = protid)

# reformat so these can be added as column to the data set
sol_summary <- sol_summary %>% 
  pivot_wider(names_from = line,
              values_from = c(mean, n, sd, se))
# merge the dataframes
sol <- merge(sol, sol_summary, by = "protid")
```

```{r}
# calculate the log fold changes for each of the comparisons
# we have p values for. This is all the pairwaise comparisions
# except that y1015 is commpared only to y101, no others
sol <- sol %>% 
  mutate(fc_y101_y1015 = log2(mean_y101/mean_y1015), # have p
         fc_y101_y102 = log2(mean_y101/mean_y102), # have p
         fc_y101_y201 = log2(mean_y101/mean_y201), # have p
         fc_y101_y202 = log2(mean_y101/mean_y202), # have p
         ##
         fc_y102_y201 = log2(mean_y102/mean_y201), # have p
         fc_y102_y202 = log2(mean_y102/mean_y202), # have p
         ##
         fc_y201_y202 = log2(mean_y201/mean_y202)) # have p
```

I used R [@R-core] with **`tidyverse`** packages [@R-tidyverse] to import and process the raw data. Bovine serum proteins from the medium on which the cells were grown and those for which fewer than two peptides were detected were filtered out. Abundances were summarised for each line-protein combination and log~2~ fold changes for pairwise comparisons between lines calculated.

## Visualisation
```{r pca-preparation}
# PCA requires the proteins to be in columns and the samples to be in rows
# Transpose the columns containing the abundance values
tsol <- sol %>% select(starts_with("y")) %>%
  t() %>% 
  data.frame()

# Use the genenames in `sol` to name the columns in `tsol`
# I'm using the genenames rather than the protein ids because they
# are more recognisable
names(tsol) <- sol$genename 

# The sample names of sol have become the row names of tsol
# put these in a column 'sample
tsol$sample <- row.names(tsol)

# process the sample name so we have the cell lineage in one column and the replicate in another
tsol <- tsol %>% 
  extract(sample, 
          c("lineage","rep"),
          "(y[0-9]{3,4})\\_([a-c])")
```

```{r pca-run}
pca <- tsol %>% 
  select(-lineage, -rep) %>%
  prcomp(scale. = TRUE)
```
Principal Components analysis with protein abundances scaled to unit variance was conducted to visualise the distance between samples in fewer dimensions. The package **`GGally`** [@GGally] was used to produced pairwise scatter plots of the first six principal components.

## Clustering and heatmaps
```{r cluster-filter}
# select genes where at least one comparison differs significantly at the q < 0.01 level
row.names(sol) <- sol$genename
sol_sigq_0.01 <- sol %>% 
  filter(q_value <= 0.001) %>% 
  select(starts_with("y")) 
```


```{r cluster-prep}
# Matrix format
sol_sigq_0.01 <- t(apply(sol_sigq_0.01, 1, z_score))
mat <- sol_sigq_0.01
mat <- as.matrix(mat)
samples <- data.frame(line = rep(c("Y101",
                                   "Y102",
                                   "Y201",
                                   "Y202",
                                   "Y1015"),
                                 each = 3))


```


Hierarchical clustering with the complete linkage method was performed for proteins and samples on the proteins that differed significantly (at the $q < 0.01$ level) between at least two lines. The abundances were z-score normalised for each protein before clustering. Z score normalisation is way to make comparisons between, and visualisations of, abundances on different scales. See Equation \@ref(eq:zscore) 

\begin{equation}
z = \frac{x_{ij} - \bar{x_{i}}}{sd_{i}}  
(\#eq:zscore)
\end{equation}



and **`pheatmap`** [@pheatmap]  

## Volcano plots
```{r volcano-prep}
sol <- merge(sol, p_q, by = "genename")
```

# Results
There were `r num_prot` human protein identified from more than two peptides.


## Principal Components analysis

```{r pca-report}
res <- summary(pca)[["importance"]]

percent1 <- res["Cumulative Proportion","PC1"] * 100
percent6 <- res["Cumulative Proportion","PC6"] * 100
```

```{r pca-vis}
pca_labelled <- data.frame(pca$x, lineage = tsol$lineage)
# a then to do a scatterplot
pca_labelled %>% 
  select(lineage,
         PC1:PC6) %>%
  ggpairs(aes(color = lineage))
```

## Clustering and heatmaps

```{r}
p <- heatmaply(mat, 
               #   xlab = "", ylab = "", 
               #   main = "",
               scale = "column",
             #  margins = c(40,40,40,20),
               grid_color = "white",
               grid_width = 0.00001,
               titleX = FALSE,
               hide_colorbar = FALSE,
               branches_lwd = 0.1,
             col_side_colors = samples,
               k_col = 5,
               label_names = c("Protein", "Sample", "Normalised Abundance"),
               fontsize_row = 7, fontsize_col = 7,
               labCol = colnames(mat),
               labRow = rownames(mat),
               heatmap_layers = theme(axis.line = element_blank())
        )
```

## Volcano plots


```{r}
sol %>% 
  ggplot(aes(x = fc_y101_y1015, 
             y = -log(q_y101_y1015),
             colour = abs(fc_y101_y1015) > 2 & q_y101_y1015 < 0.05)) +
  geom_point() +
  theme_classic() +
  theme(legend.position = "none")
```

## Word count

Word count calculated with ..

```{r wordcount}
wc_main <- wordcountaddin:::text_stats("report/main.Rmd")[3] %>% str_extract("[0-9]+") %>% as.numeric()
wc_readme <- wordcountaddin:::text_stats("README.md")[3] %>% str_extract("[0-9]+") %>% as.numeric()

```

This doc: `r wc_main`\
The README: `r wc_readme`\
Total: `r wc_main + wc_readme`

# References
